class GoogleMaps.Custom.Map
  # _.extend @prototype, Backbone.Events

  zoom: 15

  constructor: (latitude, longitude)->
    @_buildMap(latitude, longitude)
    @_setHomeMarker(latitude, longitude)

  setView: (latitude, longitude)->
    @map.panTo new google.maps.LatLng(latitude, longitude)
    @map.setZoom @zoom
    @_setHomeMarker(latitude, longitude)

  addMarker: (latitude, longitude, options={})->
    marker_options = _.defaults(options,
      position: new google.maps.LatLng(latitude, longitude)
      map: @map
    )
    marker = new google.maps.Marker(marker_options)
    marker

  removeMarker: (marker)->
    marker.setMap(null)
    marker = null

  bindPopup: (marker, content)->
    infowindow = new google.maps.InfoWindow(content: content)
    google.maps.event.addListener(marker, 'click', ->
      infowindow.open(@map, marker)
    )

  _buildMap: (latitude, longitude)->
    @map = new google.maps.Map(document.getElementById('map-canvas'),
      center: new google.maps.LatLng(latitude, longitude)
      zoom: 15
    )

  _setHomeMarker: (latitude, longitude)->
    @removeMarker(@home_marker) if @home_marker?
    home_marker = @addMarker(latitude, longitude,
      draggable:true,
    )

    infowindow = new google.maps.InfoWindow(content: "You are here")

    google.maps.event.addListener(home_marker, 'click', ->
      infowindow.open(@map, home_marker)
    )

    google.maps.event.addListener(home_marker, 'dragend', ->
      pos = home_marker.getPosition()
      GoogleMaps.Vent.trigger 'Map:home_marker:dragend', pos.lat(), pos.lng()
    )

    @home_marker = home_marker